<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>家庭作业</title>
	<meta name="viewport" content="initial-scale=1, maximum-scale=1">
	<link rel="shortcut icon" href="/favicon.ico">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<meta http-equiv="Access-Control-Allow-Origin" content="*">
	<!--ui包-->
	<link rel="stylesheet" href="../../../css/sm.css">
	<link rel="stylesheet" href="../../../css/layout.css">
	<link rel="stylesheet" href="../../../css/teacher.css">
	<!--<link rel="stylesheet" href="../../../css/weui.css">-->

	<style>
		.list-block .item-inner { border-bottom: none}
		.list-block .list-group-title { padding: .4rem .75rem;border-bottom: 1px solid #e7e7e7;}
		.label-checkbox {border-bottom: 1px solid #e7e7e7;}
		.list-block ul {
			border-bottom: none;
		}
		.item-title-row { line-height: 1.4rem}
		.chooseText {padding: 4px 40px 0; font-size:.83rem;position: absolute;}
		.list-block.media-list .list-group-title .item-media {padding:0}
		.studentDetail,.classDetail {
			width: 50%;
			height: 100%;
			position: absolute;
			right: 0;
			z-index: 9;
			top: 0;
			cursor: pointer;
		}

		.weui-uploader__file {
			float: left;
			margin-right: 9px;
			margin-bottom: 9px;
			width: 79px;
			height: 79px;
			background: no-repeat center center;
			background-size: cover;
			position: relative;
		}

		.delete{
			width: 30px;
			height: 30px;
			background:#f6383a;
			border-radius: 4px;
			position: absolute;
			right: -5px;
			top: -12px;
			color: #fff;
			text-align: center;
			line-height: 30px;
		}
		.uploader__bd {
			overflow: inherit;
		}
	</style>
</head>
<body>
<div class="page-group">
	<div class="page page-current" id="sendNotice">
		<a class="bar bar-nav external" href="list.html" style="color: #fff;">
			<span class="button button-link button-nav pull-left back"  style="padding-left: 0.75rem;">查看已发布的作业</span>
			<span class="button button-link button-nav pull-right">
				      <span class="icon icon-right"></span>
				    </span>
		</a>
		<div class="content native-scroll">
			<!--通知内容-->
			<div class="list-block" style="margin: 0;">
				<ul>
					<li class="align-top">
						<div class="item-content">
							<div class="item-inner">
								<!--通知内容-->
								<div class="item-input">
									<!--内容-->
									<textarea placeholder="请输入作业内容" id="noticeText" maxlength="1000" ></textarea>
									<!--内容-->
									<!--通知内容 End-->
								</div>
							</div>
						</div>
					</li>
					<!-- Switch (Checkbox) -->
					<li>
						<div class="item-content">
							<div class="item-inner">
								<div class="item-title"> </div>
								<div class="item-after"><span id="noticeLength">0</span>/1000</div>
							</div>
						</div>
					</li>
				</ul>
				<div class="list-block-label" id="tooLtip" style="margin-bottom: .5rem; height:.6rem"><span class="button-danger"></span></div>
			</div>
			<!--通知内容 END-->

			<!--图片上传-->
			<div class="uploader-cells" id="uploader" style="margin-top: 0">
				<div class="uploader-cell">
					<div class="uploader-cell__bd">
						<div class="uploader">
							<div class="uploader__hd">
								<!--	<p class="weui-uploader__title">图片上传</p>-->
								<span class="uploader-cells-title">选择图片</span>
								<!--<div class="uploader__info"><span id="uploadCount">0</span>/5</div>-->
							</div>
							<div class="uploader__bd">
								<ul class="uploader__files" id="uploaderFiles">
									<!--<li class="weui-uploader__file" style="background-image:url(../../../images/sng.png)"><div class="delete" data-id="j"><span class="icon icon-remove"></span></div></li>-->
								</ul>
								<div class="uploader__input-box">
									<!--<input id="uploaderInput" class="uploader__input" type="file" accept="image/*" capture="camera" multiple="" />-->
									<div id="uploaderInput" class="uploader__input"></div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!--图片上传 END-->
			<div class="list-block" style="margin:0; border-bottom: 1px solid #e7e7e7;">
				<ul>
				<!-- 	<li class="item-content item-link">
							<div class="item-inner">
								<div class="item-title">执教课程</div>
								<div class="item-after" id="changedSubject">
								   	<input type="text" placeholder="选择亲子关系" id="changedSubject" readonly="" value="" style="text-align:right;
    margin-top: -.46rem;">
								</div>
							</div>
						</li> -->
						<li>
						<div class="item-content  item-link" style="overflow: hidden">
							<div class="item-inner">
								<div class="item-title label">执教科目</div>
								<div class="item-input  item-after" id="nowsRelation">
									<input type="text" placeholder="选择执教科目" id="changedSubject" readonly="" value="" style="text-align:right;width: 70%;
    margin-top: -.36rem;">
								</div>
							</div>
						</div>
						</li>

				</ul>
			</div>

			<!--班级信息-->
			<div class="content-block-title ">
				<label class="label-checkbox item-content" id="allGrade">
					<input type="checkbox" name="checkbox" >
					<div class="item-media">
						<i class="icon icon-form-checkbox"></i>
						<span class="chooseText" style="padding-left:20px">全选</span>
					</div>
				</label>
			</div>
			<div class="list-block media-list" id="allClass">
				<!-- <ul>
                 </ul>-->
			</div>
			<!--班级信息 End-->
			<!--操作-->
			<div class="content-block">
				<a href="#" class="button button-fill" id="toSend">发送作业</a>
			</div>
			<!--操作 End-->
		</div>
	</div>
</div>


<!-- 班级学生信息-->
<div class="page" id='classDetail'>
	<header class="bar bar-nav">
		<a class="button button-link button-nav pull-left back" href="notice.html" style="padding-right:3rem;"><span class="icon icon-left"></span>返回</a>
		<a href="notice.html" class="button button-link button-nav pull-right back" id="backNotice" style="padding-left:3rem;"> 确定</a>
		<h1 class="title" id="changAllStu" style="cursor: pointer;">全选</h1>
	</header>
	<div class="content native-scroll">
		<div class="list-block media-list" style="margin:0;" id="allStudent" >
			<ul data-load="">
			</ul>
		</div>
	</div>
</div>
<!-- 班级学生信息End-->

</body>
</html>
<script src='../../../js/zepto.min.js'></script>
<script src='../../../js/sm.min.js'></script>
<script src='../../../js/config.js'></script>

<script src='http://res.wx.qq.com/open/js/jweixin-1.2.0.js'></script>
<script>

    var baseP=getJPermissions(JSON.parse(sessionStorage.baseUser).orguser.org_id);
    wx.config({
        debug: false,
        appId: baseP.appId,
        timestamp: baseP.timestamp,
        nonceStr: baseP.nonceStr,
        signature: baseP.signature,
        jsApiList: [
            'checkJsApi',
            'onMenuShareTimeline',
            'onMenuShareAppMessage',
            'onMenuShareQQ',
            'onMenuShareWeibo',
            'onMenuShareQZone',
            'hideMenuItems',
            'showMenuItems',
            'hideAllNonBaseMenuItem',
            'showAllNonBaseMenuItem',
            'translateVoice',
            'startRecord',
            'stopRecord',
            'onVoiceRecordEnd',
            'playVoice',
            'onVoicePlayEnd',
            'pauseVoice',
            'stopVoice',
            'uploadVoice',
            'downloadVoice',
            'chooseImage',
            'previewImage',
            'uploadImage',
            'downloadImage',
            'getNetworkType',
            'openLocation',
            'getLocation',
            'hideOptionMenu',
            'showOptionMenu',
            'closeWindow',
            'scanQRCode',
            'chooseWXPay',
            'openProductSpecificView',
            'addCard',
            'chooseCard',
            'openCard'
        ]
    });
</script>


<script type="text/javascript">
    //后退刷新
    window.addEventListener('pageshow', function(event) {
        if(sessionStorage.back==1){
            sessionStorage.removeItem("back");
            window.location.reload();
		}
    });
    //后退刷新
    window.addEventListener('pagehide', function(event) {
        sessionStorage.home=1;
    });

    var localhomeworkClass=JSON.parse(sessionStorage.baseUser).orguser.identityDatas[0].mapRK;

    if(localhomeworkClass.length==0){
        //$.alert("暂无班级！");
	}else{
        var localClassJson={};
        for(var i=localhomeworkClass.length-1;i>=0;i--){
            var obj=localhomeworkClass[i];
            var gradeid=obj.grade_id;

            //判断年级是否存在
            if(localClassJson[gradeid]==undefined){

                localClassJson[obj.grade_id]={};
                localClassJson[obj.grade_id]["grade_name"]=obj.grade_name;

                localClassJson[obj.grade_id]["classList"]={};//班级信息
                localClassJson[obj.grade_id]["classList"][obj.clas_id]={};
                localClassJson[obj.grade_id]["classList"][obj.clas_id]["className"]=obj.clas_name;
                localClassJson[obj.grade_id]["classList"][obj.clas_id]["students"]=[];
            }else{
                //判断班级是否重复
                if(localClassJson[gradeid]["classList"][obj.clas_id]==undefined){
                    localClassJson[gradeid]["classList"][obj.clas_id]={};
                    localClassJson[gradeid]["classList"][obj.clas_id]["className"]=obj.clas_name;
                    localClassJson[gradeid]["classList"][obj.clas_id]["students"]=[];
                }
            }

        }
        var localClass=localClassJson;
	}



    //本地存储
    var images = {
        localId: [],
        serverId: []
    };

    var ioslocId=[];//用于兼容ios的本地id列表 图片是base64格式的

    wx.ready(function (){
        //点击选择图片
        $("#uploaderInput").click(function (){

        	 wx.chooseImage({
                 count: 9-images.localId.length, // 默认9
                 sizeType: ['compressed'], // 可以指定是原图还是压缩图，默认二者都有
                 sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
                 success: function (res) {

                     $("#uploaderFiles").append("");

                     //rows="";//声明一个空字符串用于保存循环出来的html
                     images.localId =images.localId.concat(res.localIds); // 返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片
 					//去重
                     images.localId=images.localId.unique();


                     if(images.localId.length==9){
                         $("#uploaderInput").parent().hide();
                     }

                     if (window.__wxjs_is_wkwebview) {  //判断ios是不是用的 wkwebview 内核

                         for(var i=0;i<images.localId.length;i++){
                             var todel=images.localId[i];

                             wx.getLocalImgData({  //循环调用  getLocalImgData
                                 localId:res.localIds[i], // 图片的localID
                                 success: function (res) {
                                     var localData = res.localData; // localData是图片的base64数据，可以用img标签显示

                                     localData = localData.replace('jgp', 'jpeg');//iOS 系统里面得到的数据，类型为 image/jgp,因此需要替换一下

                                     /* if($.inArray(localData, ioslocId)>=0){
                                         images.localId.removeByValue(todel);
                                         return false
 									}else{ */
                                         ioslocId.push(localData)  //把base64格式的图片添加到ioslocId数组里 这样该数组里的元素都是base64格式的
                                         rows ='<li class="weui-uploader__file" data-del="'+todel+'" style="background-image:url('+localData+')"><div class="delete" ><span class="icon icon-remove"></span></div></li>';
                                         $("#uploaderFiles").append(rows);
 									//}

                                 }/*,fail:function(res){
                                     $.alert(res);
                                 }*/
                             });

                         }

                     }
                     else{  //如果不是用的wkwebview 内核 或者是用的安卓系统 执行下面的xunh
                         var rows="";
                         $.each(images.localId,function (index,el) {
                             rows  +='<li class="weui-uploader__file"  style="background-image:url('+el+')"><div class="delete" data-id="'+index+'"><span class="icon icon-remove"></span></div></li>';
                         });
                         $("#uploaderFiles").html(rows);
                     }
                 }
             });
         });

    });


    //删除所选
  /*  $("#uploaderFiles").on('click',".delete", function(event) {
        event.stopPropagation();
        var url=$(this).closest("li").css("background-image").replace('url("','').replace('")','');
        console.info(url);
        return false;
    });*/

    //预览删除
    $("#uploaderFiles").on('click',"li", function(event){
        var index=$(this).index();
        //如果点删除则删除否则执行预览操作
        if($(event.target).is("span")||$(event.target).is("div")){
            images.localId.splice(index,1);
            $(this).closest("li").remove();
            if( $("#uploaderFiles li").length<9){
                $("#uploaderInput").parent().show();
            }

        }else{
            var url=$(this).css("background-image").replace('url("','').replace('")','');
            wx.previewImage({
                current: url, // 当前显示图片的http链接
                urls: images.localId // 需要预览的图片http链接列表
            });
        }
        return false;
    });


    $(function () {

        $("#allGrade input").prop("checked",false);

        //监控通知字数
        $("#noticeText").keyup(function(){
            var cnChar=$(this).val()
            //var entryLen =cnChar.gblen();//算出实际的字符长度
            var entryLen =cnChar.length;//算出实际的字符长度
            if(entryLen>150){
                $("#tooLtip span").text("通知字数超过150字，短信仅发送提示短信。");
                //return false
            }else{
            	 $("#tooLtip span").text("");
            }
            $("#noticeLength").text(entryLen);

        }).change(function () {
            var cnChar=$(this).val()
            var entryLen =cnChar.length;//算出实际的字符长度
            if(entryLen>150){
                $("#tooLtip span").text("通知字数超过150字，短信仅发送提示短信。");
                //return false
            }else{
                $("#tooLtip span").text("");
			}
            $("#noticeLength").text(entryLen);
        });

        //粘贴事件
        $("#noticeText").bind("cut paste",function(e){
            var $this=$(this);
            setTimeout(function () {
                var cnChar=$this.val()
                var entryLen =cnChar.length;//算出实际的字符长度
                if(entryLen>150){
                    $("#tooLtip span").text("通知字数超过150字，短信仅发送提示短信。");
                    //return false
                }else{
                    $("#tooLtip span").text("");
                }
                $("#noticeLength").text(entryLen);
            },10)
        });



        //从本地获取草稿
        if(localStorage.homework!==undefined){
        	$("#noticeText").val(localStorage.homework).change();
        }
        //每10秒保存一次通知内容
        setInterval(function(){
            var homework=$("#noticeText").val();
        	if(localStorage.homework!==""){
        		localStorage.homework=homework;
        	}
		},10000);

        if(getJsonLength(localClass)==0){
            $("#allGrade ").remove();
            $("#allClass ").html('<div id="none" class="noData noData_line lastData" ><span class="noData__tips">暂无执教班级</span></div>');

        }else{
            var classHmtl="";

            for(var i in localClass){
                classHmtl +='<div class="list-group" id="'+i+'"><ul><li class="list-group-title off" >'+
                    '<label class="label-checkbox allclass">'+
                    '<input type="checkbox" name="grade">'+
                    '<div class="item-media">' +
                    '<i class="icon icon-form-checkbox"></i>' +
                    '<span class="chooseText">'+localClass[i].grade_name+'</span><span class="icon icon-down toTop"></span>'+
                    '</div></label><div class="classDetail"></div>'+
                    '</li>';

                for(var m in localClass[i].classList){
                    classHmtl +='<li id="'+m+'" class="classLabel" data-grade="'+i+'" style="display:none">'+
                        '<label class="label-checkbox item-content">'+
                        '<input type="checkbox" name="class">'+
                        '<div class="item-media"><i class="icon icon-form-checkbox"></i></div>'+
                        '<div class="item-inner">'+
                        '<div class="item-title-row">'+
                        '<div class="item-title class_name">'+localClass[i].classList[m].className+'</div>'+
                        '<div class="item-after"><span class="changedSum">已选:0</span><span class="icon icon-right"></span></div>'+
                        '</div>'+
                        '</div>'+
                        '</label>'+
                        '<div class="studentDetail"></div>'+
                        '</li>';
                }
                classHmtl +='</ul></div>';

            }

            $("#allClass ").html(classHmtl);
        }


        /*var classHmtl="";
        for(var i in localClass){
            classHmtl +='<div class="list-group" id="'+i+'"><ul><li class="list-group-title off" >'+
                '<label class="label-checkbox allclass">'+
                '<input type="checkbox" name="grade">'+
                '<div class="item-media">' +
                '<i class="icon icon-form-checkbox"></i>' +
                '<span class="chooseText">'+localClass[i].grade_name+'</span><span class="icon icon-down toTop"></span>'+
                '</div></label><div class="classDetail"></div>'+
                '</li>';

            for(var m in localClass[i].classList){
                classHmtl +='<li id="'+m+'" class="classLabel" data-grade="'+i+'" style="display:none">'+
                    '<label class="label-checkbox item-content">'+
                    '<input type="checkbox" name="class">'+
                    '<div class="item-media"><i class="icon icon-form-checkbox"></i></div>'+
                    '<div class="item-inner">'+
                    '<div class="item-title-row">'+
                    '<div class="item-title class_name">'+localClass[i].classList[m].className+'</div>'+
                    '<div class="item-after"><span class="changedSum">已选:0</span><span class="icon icon-right"></span></div>'+
                    '</div>'+
                    '</div>'+
                    '</label>'+
                    '<div class="studentDetail"></div>'+
                    '</li>';
            }
            classHmtl +='</ul></div>';

        }
        $("#allClass ").html(classHmtl);*/

        //全选操作(年级班级学生)
       /* $("#allGrade").click(function(e){

            setTimeout(function(){
            	if(!$(this).hasClass("off")){

                    $("input[name=class],input[name=grade]").prop("checked",true);
                    $(".changedSum").text("全部");
                    //班级下的学生默认全部选中
                    for(var m in localClass){
                        localClass[m].changed=true;
                        for(var i in localClass[m]["classList"]){
                            var obj=localClass[m]["classList"][i];
                            obj.changed=true;
                        }
                    }

                }else{
                    $("input[name=class],input[name=grade]").prop("checked",false);
                    $(".changedSum").text("0");
                    for(var m in localClass){
                        delete localClass[m]["changed"];
                        for(var i in localClass[m]["classList"]){
                            var obj=localClass[m]["classList"][i];
                            delete obj["changed"];
                        }
                    }
                }
            },10);
        });*/

        $("#allGrade").click(function(e){
            var $this=$(this);
            setTimeout(function(){
                if($this.find("input").is(":checked")){
                    $this.addClass("off");
                    $("input[name=class],input[name=grade]").prop("checked",true);
                    $(".changedSum").text("全部");
                    //班级下的学生默认全部选中
                    for(var m in localClass){
                        localClass[m].changed=true;
                        for(var i in localClass[m]["classList"]){
                            var obj=localClass[m]["classList"][i];
                            obj.changed=true;
                        }
                    }
                    $("#allGrade .chooseText").text("取消全选");
                }else{
                    $this.removeClass("off");
                    $("input[name=class],input[name=grade]").prop("checked",false);
                    $(".changedSum").text("已选:0");
                    for(var m in localClass){
                        delete localClass[m]["changed"];
                        for(var i in localClass[m]["classList"]){
                            var obj=localClass[m]["classList"][i];
                            delete obj["changed"];
                        }
                    }
                    $("#allGrade .chooseText").text("全选");
                }
            },10);
        });


        //年级全选
        $(".allclass").click(function(){
            var $this=$(this);
            var m=$this.closest(".list-group").attr("id");
            setTimeout(function(){
                if($this.find("input").is(":checked")){

                    $this.closest("ul").find("input[name=class]").prop("checked",true);
                    $this.closest("ul").find(".changedSum").text("全部");

                    if($("input[name=grade]").length==$("input[name=grade]:checked").length){
                        $("#allGrade input").prop("checked",true);
                        $("#allGrade .chooseText").text("取消全选");
                    }

                    //班级下的学生默认全部选中
                    localClass[m].changed=true;
                    for(var i in localClass[m]["classList"]){
                        var obj=localClass[m]["classList"][i];
                        obj.changed=true;
                    }
                }else{
                    $this.closest("ul").find("input[name=class]").prop("checked",false);
                    $this.closest("ul").find(".changedSum").text("已选:0");

                    //有取消则取消年级全选
                    $("#allGrade input").prop("checked",false);
                    $("#allGrade").find(".chooseText").text("全选");

                    delete localClass[m]["changed"];
                    for(var i in localClass[m]["classList"]){
                        var obj=localClass[m]["classList"][i];
                        delete obj["changed"];
                    }
                }
            },10)
        });


        //查看班级学生详情
        $('body').on('click',".studentDetail", function(event){

            var classId=$(this).closest("li").attr("id");
            var gradeId=$(this).closest("div.list-group").attr("id");

            $("#backNotice").attr("data-cid",classId).attr("data-gid",gradeId);

            //是否全选
            if($(this).closest(".classLabel").find("input").is(":checked")){
                $("#changAllStu").addClass("changAllStu").text("取消全选");
            }else{
                $("#changAllStu").removeClass("changAllStu").text("全选");
            }

            var ports=domainName+"/esb/api/student/getStudentsByCid";
            var parameter={
                token:JSON.parse(sessionStorage.baseUser).token,
                udid:JSON.parse(sessionStorage.baseUser).udid, //最后从cookie里去
                version:"3",  //终端
                clas_id:classId
            }
            var studentHtml="";


            if(localClass[gradeId]["classList"][classId]["students"].length>0){

                var localAllClass=localClass[gradeId].classList[classId].students

                for(var i=0;i<localClass[gradeId]["classList"][classId]["students"].length;i++) {

                    var obj=localClass[gradeId]["classList"][classId]["students"][i];

                    if(localClass[gradeId].classList[classId].changed==true){
                        $("#changAllStu").addClass("changAllStu").text("取消全选");
                        var changedhtml="checked=checked";
                    }else{
                        if(obj.changed==true){
                            var changedhtml="checked=checked";
                        }else{
                            var changedhtml="";
                        }

                    }
                    studentHtml +='<li>'+
                        '<label class="label-checkbox item-content">'+
                        '<input type="checkbox" name="student"  id="'+obj.id+'" '+changedhtml+' >'+
                        '<div class="item-media"><i class="icon icon-form-checkbox"></i></div>'+
                        '<div class="item-inner">'+
                        '<div class="item-title-row">'+
                        '<div class="item-title class_name">'+obj.name+'</div>'+
                        '<div class="item-after "></div>'+
                        '</div>'+
                        '</div>'+
                        '</label>'+
                        '</li>';
                    $("#allStudent ul").html(studentHtml);

                }
            }else{
                //获取消息
                getData(ports,parameter,function(res){
                    if(res.code==200 && res.success==true){

                        for(var i=0;i<res.data.length;i++) {

                            var obj={id:res.data[i].stud_id,name:res.data[i].stud_name};

                            localClass[gradeId]["classList"][classId]["students"].push(obj);

                          if(  localClass[gradeId]["classList"][classId].changed==true){

                                var changedhtml="checked=checked";

                                for(var m=localClass[gradeId]["classList"][classId]["students"].length-1;m>=0;m--){
                                    localClass[gradeId]["classList"][classId]["students"][m].changed=true
								}

                            }else{
                                var changedhtml="";
                            }
                            studentHtml +='<li >'+
                                '<label class="label-checkbox item-content">'+
                                '<input type="checkbox" name="student"  id="'+res.data[i].stud_id+'"  '+changedhtml+'>'+
                                '<div class="item-media"><i class="icon icon-form-checkbox"></i></div>'+
                                '<div class="item-inner">'+
                                '<div class="item-title-row">'+
                                '<div class="item-title class_name">'+res.data[i].stud_name+'</div>'+
                                '<div class="item-after "></div>'+
                                '</div>'+
                                '</div>'+
                                '</label>'+
                                '</li>';
                        }

                        $("#allStudent ul").html(studentHtml);

                    }else{
                        $.alert(res.message);
                    }
                });
            }

            $.router.loadPage("#classDetail");

        });

        //确认所选人员
        $("#backNotice").click(function(){

            var gradeId=$(this).attr("data-gid"),classId=$(this).attr("data-cid");
            //清空
            var obj=localClass[gradeId].classList[classId].students;
            for(var m=obj.length-1;m>=0;m--){
                delete obj[m]["changed"];
            }

            var changedsum=0;
            $("#allStudent ul input:checked").each(function(){
                var studentId=parseInt($(this).attr("id"));
                for(var n=obj.length-1;n>=0;n--){
                    var localParam=obj[n].id;
                    if(localParam==studentId){
                        obj[n].changed=true;
                        changedsum+=1;
                        break;
                    }
                }
            });

            if($("#allStudent ul input:checked").length==obj.length){

                //全选则班级是选中状态
                $("#"+classId).find("input").prop("checked",true);
                localClass[gradeId].classList[classId].changed=true;

                $("#"+classId).find(".changedSum").text("全部");

                //如果选择班级全部选择，则年级全选
                if($("#"+gradeId).find("input[name=class]").length==$("#"+gradeId).find("input[name=class]:checked").length){
                    $("#"+gradeId).find("input[name=grade]").prop("checked",true);
                }
                //如果年级全部选择，则全部年级全选
                if($("input[name=grade]").length==$("input[name=grade]:checked").length){
                    $("#allGrade input").prop("checked",true);
                    $("#allGrade .chooseText").text("取消全选");
                }
                $("#changAllStu").addClass("changAllStu").text("取消全选");

            }else{

                $("#"+classId).find("input").prop("checked",false);
                $("#"+classId).find(".changedSum").text("已选:"+changedsum);

                $("#"+gradeId).find("input[name=grade]").prop("checked",false);
                $("#allGrade input").prop("checked",false);
                $("#allGrade .chooseText").text("取消全选");

                $("#changAllStu").removeClass("changAllStu").text("全选");

                //只要不是全选都是未选中状态
                $("#"+classId).find("input").prop("checked",false);
                delete localClass[gradeId].classList[classId]["changed"]
            }

        });


        //选择/取消全部学生
        $("#changAllStu").click(function(){

            if($(this).hasClass("changAllStu")){
                $(this).removeClass("changAllStu").text("全选");
                $("#allStudent ul input").prop("checked",false)

            }else{
                $(this).addClass("changAllStu").text("取消全选");
                $("#allStudent ul input").prop("checked",true)
            }
        });


        //选择班级判断
        $('body').on('click',"li.classLabel label", function(event){
            var $this=$(this).parent();
            if($(event.target).hasClass("studentDetail")){
                return false
            }
            var gradeId=$this.attr("data-grade");
            var classId=$this.attr("id");
            var obj=localClass[gradeId]["classList"][classId];

            setTimeout(function(){
                if(!$this.find("input").is(":checked")){
                    delete obj["changed"];
                    $this.find(".changedSum").text("已选:0");

                    //取消全部年级和年级的全选
                    $("#"+gradeId).find("input[name=grade]").prop("checked",false);
                    $("#allGrade input").prop("checked",false);
                    $("#allGrade .chooseText").text("全选");

                    $("#changAllStu").removeClass("changAllStu").text("全选");

                    if(obj.students.length!==0){
                        for(var i=obj.students.length-1;i>=0;i--){
                            delete obj.students[i].changed
                        }
                    }

                }else{

                    //如果选择班级全部选择，则年级全选
                    if($("#"+gradeId).find("input[name=class]").length==$("#"+gradeId).find("input[name=class]:checked").length){
                        $("#"+gradeId).find("input[name=grade]").prop("checked",true);
                    }
                    //如果年级全部选择，则全部年级全选
                    if($("input[name=grade]").length==$("input[name=grade]:checked").length){
                        $("#allGrade input").prop("checked",true);
                        $("#allGrade .chooseText").text("取消全选");
                    }

                    obj["changed"]=true;

                    if(obj.students.length!==0){
                        for(var i=obj.students.length-1;i>=0;i--){
                            obj.students[i].changed=true
                        }
                    }
                    $("#changAllStu").addClass("changAllStu").text("取消全选");
                    $this.find(".changedSum").text("全部");
                }
            },10)
        });


        //折叠班级
        $('body').on('click',".list-group-title", function(event){

            if($(event.target).hasClass("classDetail")){
                if($(this).hasClass("off")){
                    $(this).nextAll().show();
                    $(this).removeClass("off");
                    $(this).find(".icon-down").removeClass("toTop").addClass("todown");
                }else{
                    $(this).nextAll().hide();
                    $(this).addClass("off");
                    $(this).find(".icon-down").addClass("toTop").removeClass("todown");
                }
            }
        });

        //发送通知
        $("#toSend").click(function(){
            var message=$.trim($("#noticeText").val());//通知内容
            if(message==""){
                $.alert("通知内容不能为空！");
                return false
            }

            /*  if(message.length>100){
                  $.alert("通知内容不能超过150字！");
                  return false
              }*/

            //科目判断
            var val=$("#changedSubject").val();
			var suject=JSON.parse(sessionStorage.baseUser).orguser.identityDatas[0].mapKC;
            var changedSuject=0;
			   for(var i=suject.length-1;i>=0;i--){
			       	  if(suject[i].course_name==val){
			       		changedSuject=suject[i].cour_id;
			          }
			    }

		    if(changedSuject==0){
         	   $.alert("请选择一个科目！");
         	   return false
            }


            var changedStudent=[];
            var changedClass=[];
            var changedGrade=[];

            var upData=localClass;


            var temporaryStudent=[]
            //获取发送对象
            for(var m in upData){
                var classSum=0;

                for(var n in  upData[m].classList){
                    var studentSum=0;
                    if(upData[m].classList[n].students.length>0){
                        for(var x=upData[m].classList[n].students.length-1;x>=0;x--){
                            if(upData[m].classList[n].students[x].changed==true){
                                studentSum +=1;
                                temporaryStudent.push(n+"_"+upData[m].classList[n].students[x].id)
                            }

                           if(x==0){
                                if(studentSum==upData[m].classList[n].students.length){
                                    $("#"+n).find(".changedSum").text("全部");
                                    upData[m].classList[n].changed==true;
                                    changedClass.push(n);
                                    temporaryStudent=[];
                                    classSum +=1;
                                }else{
                                    changedStudent=temporaryStudent;
                                    delete localClass[m].classList[n].changed;
                                }
							}
                        }
					}else{
						if(upData[m].classList[n].changed==true){
							changedClass.push(n);
						}
					}
                }

            }


           if(changedStudent.length==0&&changedClass.length==0&&changedGrade.length==0){
                $.alert("请选择发送对象！");
                return false
            }

           //保存提示
           $.showPreloader("正在发布，请稍后");

            //如果都上传完毕则保存到本地数据库
            base =JSON.parse(sessionStorage.baseUser);
           if(images.localId.length>0){
               HandleData(images.localId.length)
		   }else{

			   var val=$("#changedSubject").val();
			   var suject=JSON.parse(sessionStorage.baseUser).orguser.identityDatas[0].mapKC;

               var parameter={
                   token:base.token,
                   udid:base.udid,
                   version:3,
                   uid:base.orguser.user_id,
                   org_id:base.orguser.org_id,
                   content:message,
                   target:JSON.stringify({"c":changedClass,"s":changedStudent,"g":changedGrade}),
                   is_receipt:0,
                   media:images.serverId.join(","),
                   type:3,
                   cour_id:changedSuject
               }

               getDataNoLoading(domainName+"/eduWeixin/notice/SendNotice", parameter,function(result){
            		$.hidePreloader();
                   if(result.code==200 && result.success==true){
                	    //清空本地存储
	                   	localStorage.removeItem("homework");
                       //系统时间
                       $.alert("发布成功！",function(){
                           window.location="list.html";
                       });
                       setTimeout(function(){window.location="list.html"},600);
                   }else{
                       $.alert(result.msg);
                   }
               },"POST");
		   }


            function HandleData(n) {
                 var m=0;
				(function loadData(m){

					wx.uploadImage({
						localId: images.localId[m], // 需要上传的图片的本地ID，由chooseImage接口获得
						isShowProgressTips: 0,// 默认为1，显示进度提示
						success: function (res) {
							images.serverId.push(res.serverId); // 返回图片的服务器端ID
							if(m<(n-1)){
								loadData(m+1);
							}else{

								 var val=$("#changedSubject").val();
								   var suject=JSON.parse(sessionStorage.baseUser).orguser.identityDatas[0].mapKC;
					               var changedSuject
								   for(var i=suject.length-1;i>=0;i--){
								       	  if(suject[i].course_name==val){
								       		changedSuject=suject[i].cour_id;
								          }
								    }

                                var parameter={
                                    token:base.token,
                                    udid:base.udid,
                                    version:3,
                                    uid:base.orguser.user_id,
                                    org_id:base.orguser.org_id,
                                    content:message,
                                    target:JSON.stringify({"c":changedClass,"s":changedStudent,"g":changedGrade}),
                                    is_receipt:0,
                                    media:images.serverId.join(","),
                                    type:3,
                                    cour_id:changedSuject
                                }

                                getDataNoLoading(domainName+"/eduWeixin/notice/SendNotice", parameter,function(result){
                                	$.hidePreloader();
                                    if(result.code==200 && result.success==true){
                                    	//清空本地存储
					                   	localStorage.removeItem("homework");
                                        //系统时间
                                        $.alert("发布成功！",function(){
                                            window.location="list.html";
                                        });
                                        setTimeout(function(){window.location="list.html"},600);
                                    }else{
                                        $.alert(result.msg);
                                    }
                                },"POST");
							}
						}
					});
				}(m));
			}

        });

       //科目设置
       var suject=JSON.parse(sessionStorage.baseUser).orguser.identityDatas[0].mapKC;
       var subjectArr=[]
       for(var i=suject.length-1;i>=0;i--){
    	   subjectArr.push(suject[i].course_name)
       }

       if(subjectArr.length!==0){
				   //选择科目
				   $("#changedSubject").picker({
					   toolbarTemplate: '<header class="bar bar-nav">\
			  <button class="button button-link pull-right close-picker">确定</button>\
			  <h1 class="title">选择科目</h1>\
			  </header>',
					   cols: [
						   {
							   textAlign: 'center',
							   values: subjectArr
						   }
					   ],/* ,formatValue:function(a){console.info(a.displayValue[0])} */
                       onOpen:function () {
                           $(".native-scroll").css("overflow","hidden");
                       },
                       onClose:function() {
                           $(".native-scroll").css("overflow","auto");
                       }
				   });
	   }else{
           $("#changedSubject").val("未设置");
           $("#changedSubject").click(function () {
               $.alert("执教科目暂无设置，去个人中心去设置？","提示",function () {
				   window.location="../set/index.html"
               })
           });

	   }



    });
</script>
